var _=Symbol("Comlink.proxy"),j=Symbol("Comlink.endpoint"),H=Symbol("Comlink.releaseProxy"),L=Symbol("Comlink.thrown"),D=t=>typeof t=="object"&&t!==null||typeof t=="function",G={canHandle:t=>D(t)&&t[_],serialize(t){let{port1:e,port2:s}=new MessageChannel;return A(t,e),[s,[s]]},deserialize(t){return t.start(),W(t)}},V={canHandle:t=>D(t)&&L in t,serialize({value:t}){let e;return t instanceof Error?e={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:e={isError:!1,value:t},[e,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},q=new Map([["proxy",G],["throw",V]]);function A(t,e=self){e.addEventListener("message",function s(r){if(!r||!r.data)return;let{id:i,type:n,path:a}=Object.assign({path:[]},r.data),o=(r.data.argumentList||[]).map(p),c;try{let l=a.slice(0,-1).reduce((m,f)=>m[f],t),u=a.reduce((m,f)=>m[f],t);switch(n){case"GET":c=u;break;case"SET":l[a.slice(-1)[0]]=p(r.data.value),c=!0;break;case"APPLY":c=u.apply(l,o);break;case"CONSTRUCT":{let m=new u(...o);c=K(m)}break;case"ENDPOINT":{let{port1:m,port2:f}=new MessageChannel;A(t,f),c=Z(m,[m])}break;case"RELEASE":c=void 0;break;default:return}}catch(l){c={value:l,[L]:0}}Promise.resolve(c).catch(l=>({value:l,[L]:0})).then(l=>{let[u,m]=v(l);e.postMessage(Object.assign(Object.assign({},u),{id:i}),m),n==="RELEASE"&&(e.removeEventListener("message",s),C(e))})}),e.start&&e.start()}function B(t){return t.constructor.name==="MessagePort"}function C(t){B(t)&&t.close()}function W(t,e){return M(t,[],e)}function T(t){if(t)throw new Error("Proxy has been released and is not useable")}function M(t,e=[],s=function(){}){let r=!1,i=new Proxy(s,{get(n,a){if(T(r),a===H)return()=>h(t,{type:"RELEASE",path:e.map(o=>o.toString())}).then(()=>{C(t),r=!0});if(a==="then"){if(e.length===0)return{then:()=>i};let o=h(t,{type:"GET",path:e.map(c=>c.toString())}).then(p);return o.then.bind(o)}return M(t,[...e,a])},set(n,a,o){T(r);let[c,l]=v(o);return h(t,{type:"SET",path:[...e,a].map(u=>u.toString()),value:c},l).then(p)},apply(n,a,o){T(r);let c=e[e.length-1];if(c===j)return h(t,{type:"ENDPOINT"}).then(p);if(c==="bind")return M(t,e.slice(0,-1));let[l,u]=R(o);return h(t,{type:"APPLY",path:e.map(m=>m.toString()),argumentList:l},u).then(p)},construct(n,a){T(r);let[o,c]=R(a);return h(t,{type:"CONSTRUCT",path:e.map(l=>l.toString()),argumentList:o},c).then(p)}});return i}function z(t){return Array.prototype.concat.apply([],t)}function R(t){let e=t.map(v);return[e.map(s=>s[0]),z(e.map(s=>s[1]))]}var x=new WeakMap;function Z(t,e){return x.set(t,e),t}function K(t){return Object.assign(t,{[_]:!0})}function v(t){for(let[e,s]of q)if(s.canHandle(t)){let[r,i]=s.serialize(t);return[{type:"HANDLER",name:e,value:r},i]}return[{type:"RAW",value:t},x.get(t)||[]]}function p(t){switch(t.type){case"HANDLER":return q.get(t.name).deserialize(t.value);case"RAW":return t.value}}function h(t,e,s){return new Promise(r=>{let i=X();t.addEventListener("message",function n(a){!a.data||!a.data.id||a.data.id!==i||(t.removeEventListener("message",n),r(a.data))}),t.start&&t.start(),t.postMessage(Object.assign({id:i},e),s)})}function X(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}var y=class{static calculatePeak(e,s,r){let i=[];for(let n of e){let a=!1;for(let o=0;o<i.length;o++){let c=i[o],l=c.value*(1+s),u=c.value*(1-s);if(n>=u&&n<=l){a=!0,c.count+=2,c.value=(c.value*(c.count-1)+n)/c.count,i[o]=c;break}}a||i.push({value:n,count:1})}i.sort((n,a)=>a.count-n.count);for(let n of i){let a=n.value;if(a>=r)return a}return r}};var k=class t{static mikelsFrequency(e,s,r){let i=0,a=t.calculatePeaks(e,2,e.length,0);a.sort((f,d)=>e[d]-e[f]);let o=5,c=10,l=0,u=0,m=s/r;for(let f=0;f<o;f++){let d=a[f],N=0;for(let F=0;F<c;F++){let I=d+F*d,U=I-2,O=I+2,S=-1;for(let b=U;b<=O;b++)b<e.length&&e[b]>S&&(S=e[b]);N+=S}N>l&&(l=N,u=d)}return i=u*m,i}static calculatePeaks(e,s,r,i){let n=0;if(i>0)for(let o=0;o<r;o++)e[o]>n&&(n=e[o]);n*=i;let a=[];if(r>=s)for(let o=s;o<r-s;o++){let c=!0;if(e[o]>=n){for(let l=0;l<s;l++)if(e[o]<e[o-l]||e[o]<e[o+l]){c=!1;break}}else c=!1;c&&a.push(o)}return a}};var E=1.05946309436,Q=E*E,Y=33,$=87,J=21,ee=["D","E","F","G","A","B","C","C","D","E","F","G","A","B","C","C","D","E","F","G","A","B","C","C","D","E","F","G","A","B","C","C","D"],te={Bb:233.08,B:246.94,C:261.63,D:293.66,Eb:311.13,F:349.23,G:392};var w=class t{fundamentalFrequency;pitchModel;knownFrequencies;midiNotes;constructor(e="D",s="major"){this.fundamentalFrequency=te[e],this.pitchModel=0,this.knownFrequencies=new Array(Y),this.midiNotes=new Array($),this.makeScale(s),this.makeMidiNotes()}makeScale(e){let s=[1,2,4,5];if(e=="major"){this.pitchModel==0?this.knownFrequencies[0]=this.fundamentalFrequency/Math.pow(E,12):this.knownFrequencies[0]=this.fundamentalFrequency;for(let r=1;r<this.knownFrequencies.length;r++)t.isWholeToneInterval(r,s)?this.knownFrequencies[r]=this.knownFrequencies[r-1]*Q:this.knownFrequencies[r]=this.knownFrequencies[r-1]*E}}static isWholeToneInterval(e,s){return e%=8,s.some(r=>r==e)}makeMidiNotes(){this.midiNotes[0]=27.5;for(let e=1;e<this.midiNotes.length;e++)this.midiNotes[e]=this.midiNotes[e-1]*E}spellFrequency(e){let s=0,r=Number.MAX_VALUE;if(e<this.knownFrequencies[0]||e>this.knownFrequencies.slice(-1)[0])return"Z";for(let i=0;i<this.knownFrequencies.length;i++){let n=Math.abs(e-this.knownFrequencies[i]);n<r&&(s=i,r=n)}return ee[s]}spellFrequencyAsMidi(e){let s=0,r=Number.MAX_VALUE;if(e<this.midiNotes[0]||e>this.midiNotes.slice(-1)[0])return"Z";for(let i=0;i<this.midiNotes.length;i++){let n=Math.abs(e-this.midiNotes[i]);n<r&&(s=i,r=n)}return s+=J,s.toString()}};var ne=44100,re=4096,se=12,ie=0,ae=20/1e3,oe="D",g=class{inputSampleRate;sampleTime;blankTime;tickTime;fundamental;frameSize;constructor(e){this.inputSampleRate=e.inputSampleRate||ne,this.sampleTime=e.sampleTime||se,this.blankTime=e.blankTime||ie,this.tickTime=e.tickTime||ae,this.fundamental=e.fundamental||oe,this.frameSize=e.frameSize||re}transcribe(e){let s=new w(this.fundamental),r=[],i="",n=0;for(let o of e){let c=o.map(m=>this.decibelToLinear(m)),l=k.mikelsFrequency(Array.from(c),this.inputSampleRate,this.frameSize),u=s.spellFrequency(l);if(u!=i){i=u;let m={spelling:u,frequency:l,onset:n};r.push(m)}n+=this.tickTime}return this.postProcess(r)}postProcess(e){let s="";for(let n=0;n<e.length-1;n++)e[n].duration=e[n+1].onset-e[n].onset,e[n].duration<0&&console.log(e[n+1].onset,e[n].onset);e.slice(-1)[0].duration=this.blankTime+this.sampleTime-e.slice(-1)[0].onset;let r=new Array(e.length);for(let n=0;n<e.length;n++)r[n]=e[n].duration;let i=y.calculatePeak(r,.33,.1);for(let n of e){if(n.spelling=="Z")continue;n.quavers=Math.round(n.duration/i);let a=n.spelling;a=a.repeat(n.quavers),s+=a}return s}decibelToLinear(e){return Math.pow(10,e/20)}};var P=class{transcriber;signal;initialize(e){this.transcriber=new g(e),this.resetSignal()}resetSignal(){this.signal=[]}transcribe(){let e=this.transcriber.transcribe(this.signal);return console.log(`transcription: ${e}`),{transcription:e}}pushSignal(e){this.signal.push(e);let s=Number.MIN_VALUE;for(let r of e)r>s&&(s=r);return{numSamples:e.length}}},ce=new P;A(ce);export{P as TranscriberImpl};
