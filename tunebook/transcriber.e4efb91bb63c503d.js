(()=>{"use strict";const _=Symbol("Comlink.proxy"),U=Symbol("Comlink.endpoint"),O=Symbol("Comlink.releaseProxy"),k=Symbol("Comlink.thrown"),D=t=>"object"==typeof t&&null!==t||"function"==typeof t,I=new Map([["proxy",{canHandle:t=>D(t)&&t[_],serialize(t){const{port1:e,port2:r}=new MessageChannel;return y(t,e),[r,[r]]},deserialize:t=>(t.start(),function j(t,e){return b(t,[],e)}(t))}],["throw",{canHandle:t=>D(t)&&k in t,serialize({value:t}){let e;return e=t instanceof Error?{isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:{isError:!1,value:t},[e,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}}]]);function y(t,e=self){e.addEventListener("message",function r(s){if(!s||!s.data)return;const{id:o,type:a,path:n}=Object.assign({path:[]},s.data),i=(s.data.argumentList||[]).map(m);let c;try{const l=n.slice(0,-1).reduce((f,h)=>f[h],t),u=n.reduce((f,h)=>f[h],t);switch(a){case"GET":c=u;break;case"SET":l[n.slice(-1)[0]]=m(s.data.value),c=!0;break;case"APPLY":c=u.apply(l,i);break;case"CONSTRUCT":c=function W(t){return Object.assign(t,{[_]:!0})}(new u(...i));break;case"ENDPOINT":{const{port1:f,port2:h}=new MessageChannel;y(t,h),c=function V(t,e){return R.set(t,e),t}(f,[f])}break;case"RELEASE":c=void 0;break;default:return}}catch(l){c={value:l,[k]:0}}Promise.resolve(c).catch(l=>({value:l,[k]:0})).then(l=>{const[u,f]=w(l);e.postMessage(Object.assign(Object.assign({},u),{id:o}),f),"RELEASE"===a&&(e.removeEventListener("message",r),C(e))})}),e.start&&e.start()}function C(t){(function H(t){return"MessagePort"===t.constructor.name})(t)&&t.close()}function T(t){if(t)throw new Error("Proxy has been released and is not useable")}function b(t,e=[],r=function(){}){let s=!1;const o=new Proxy(r,{get(a,n){if(T(s),n===O)return()=>d(t,{type:"RELEASE",path:e.map(i=>i.toString())}).then(()=>{C(t),s=!0});if("then"===n){if(0===e.length)return{then:()=>o};const i=d(t,{type:"GET",path:e.map(c=>c.toString())}).then(m);return i.then.bind(i)}return b(t,[...e,n])},set(a,n,i){T(s);const[c,l]=w(i);return d(t,{type:"SET",path:[...e,n].map(u=>u.toString()),value:c},l).then(m)},apply(a,n,i){T(s);const c=e[e.length-1];if(c===U)return d(t,{type:"ENDPOINT"}).then(m);if("bind"===c)return b(t,e.slice(0,-1));const[l,u]=P(i);return d(t,{type:"APPLY",path:e.map(f=>f.toString()),argumentList:l},u).then(m)},construct(a,n){T(s);const[i,c]=P(n);return d(t,{type:"CONSTRUCT",path:e.map(l=>l.toString()),argumentList:i},c).then(m)}});return o}function G(t){return Array.prototype.concat.apply([],t)}function P(t){const e=t.map(w);return[e.map(r=>r[0]),G(e.map(r=>r[1]))]}const R=new WeakMap;function w(t){for(const[e,r]of I)if(r.canHandle(t)){const[s,o]=r.serialize(t);return[{type:"HANDLER",name:e,value:s},o]}return[{type:"RAW",value:t},R.get(t)||[]]}function m(t){switch(t.type){case"HANDLER":return I.get(t.name).deserialize(t.value);case"RAW":return t.value}}function d(t,e,r){return new Promise(s=>{const o=function z(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}();t.addEventListener("message",function a(n){!n.data||!n.data.id||n.data.id!==o||(t.removeEventListener("message",a),s(n.data))}),t.start&&t.start(),t.postMessage(Object.assign({id:o},e),r)})}class L{static mikelsFrequency(e,r,s){let o=0;const n=L.calculatePeaks(e,2,e.length,0);n.sort((h,g)=>e[g]-e[h]);let l=0,u=0;const f=r/s;for(let h=0;h<5;h++){const g=n[h];let N=0;for(let S=0;S<10;S++){const q=g+S*g,le=q+2;let M=-1;for(let A=q-2;A<=le;A++)A<e.length&&e[A]>M&&(M=e[A]);N+=M}N>l&&(l=N,u=g)}return o=u*f,o}static calculatePeaks(e,r,s,o){let a=0;if(o>0)for(let i=0;i<s;i++)e[i]>a&&(a=e[i]);a*=o;const n=[];if(s>=r)for(let i=r;i<s-r;i++){let c=!0;if(e[i]>=a){for(let l=0;l<r;l++)if(e[i]<e[i-l]||e[i]<e[i+l]){c=!1;break}}else c=!1;c&&n.push(i)}return n}}const E=1.05946309436,Y=["D","E","F","G","A","B","C","C","D","E","F","G","A","B","C","C","D","E","F","G","A","B","C","C","D","E","F","G","A","B","C","C","D"],$={Bb:233.08,B:246.94,C:261.63,D:293.66,Eb:311.13,F:349.23,G:392};var p=(()=>{return(t=p||(p={}))[t.FLUTE=0]="FLUTE",t[t.WHISTLE=1]="WHISTLE",p;var t})();class F{constructor(e="D",r="major"){this.fundamentalFrequency=$[e],this.pitchModel=p.FLUTE,this.knownFrequencies=new Array(33),this.midiNotes=new Array(87),this.makeScale(r),this.makeMidiNotes()}makeScale(e){const r=[1,2,4,5];if("major"==e){this.knownFrequencies[0]=this.pitchModel==p.FLUTE?this.fundamentalFrequency/Math.pow(E,12):this.fundamentalFrequency;for(let s=1;s<this.knownFrequencies.length;s++)this.knownFrequencies[s]=F.isWholeToneInterval(s,r)?1.1224620483108665*this.knownFrequencies[s-1]:this.knownFrequencies[s-1]*E}}static isWholeToneInterval(e,r){return e%=8,r.some(s=>s==e)}makeMidiNotes(){this.midiNotes[0]=27.5;for(let e=1;e<this.midiNotes.length;e++)this.midiNotes[e]=this.midiNotes[e-1]*E}spellFrequency(e){let r=0,s=Number.MAX_VALUE;if(e<this.knownFrequencies[0]||e>this.knownFrequencies.slice(-1)[0])return"Z";for(let o=0;o<this.knownFrequencies.length;o++){const a=Math.abs(e-this.knownFrequencies[o]);a<s&&(r=o,s=a)}return Y[r]}spellFrequencyAsMidi(e){let r=0,s=Number.MAX_VALUE;if(e<this.midiNotes[0]||e>this.midiNotes.slice(-1)[0])return"Z";for(let o=0;o<this.midiNotes.length;o++){const a=Math.abs(e-this.midiNotes[o]);a<s&&(r=o,s=a)}return r+=21,r.toString()}}class ie{constructor(e){this.inputSampleRate=e.inputSampleRate||44100,this.sampleTime=e.sampleTime||12,this.blankTime=e.blankTime||2,this.tickTime=e.tickTime||.02,this.fundamental=e.fundamental||"D",this.frameSize=e.frameSize||4096}transcribe(e){const r=new F(this.fundamental),s=[];let o="",a=0;for(const i of e){const c=i.map(f=>this.decibelToLinear(f)),l=L.mikelsFrequency(Array.from(c),this.inputSampleRate,this.frameSize),u=r.spellFrequency(l);u!=o&&(o=u,s.push({spelling:u,frequency:l,onset:a})),a+=this.tickTime}return this.postProcess(s,!1)}postProcess(e,r){let s="";for(let n=0;n<e.length-1;n++)e[n].duration=e[n+1].onset-e[n].onset,e[n].duration<0&&console.log(e[n+1].onset,e[n].onset);e.slice(-1)[0].duration=this.blankTime+this.sampleTime-e.slice(-1)[0].onset;const o=new Array(e.length);for(let n=0;n<e.length;n++)o[n]=e[n].duration;const a=class B{static calculatePeak(e,r,s){const o=[];for(const a of e){let n=!1;for(let i=0;i<o.length;i++){const c=o[i],l=c.value*(1+r);if(a>=c.value*(1-r)&&a<=l){n=!0,c.count+=2,c.value=(c.value*(c.count-1)+a)/c.count,o[i]=c;break}}n||o.push({value:a,count:1})}o.sort((a,n)=>n.count-a.count);for(const a of o){const n=a.value;if(n>=s)return n}return s}}.calculatePeak(o,.33,.1);for(const n of e){if("Z"==n.spelling)continue;n.quavers=Math.round(n.duration/a);let i=n.spelling;r&&(i+=","),i=i.repeat(n.quavers),s+=i}return s}decibelToLinear(e){return Math.pow(10,e/20)}}y(new class oe{initialize(e){this.transcriber=new ie(e),this.resetSignal()}resetSignal(){this.signal=[]}transcribe(){const e=this.transcriber.transcribe(this.signal);return console.log(`transcription: ${e}`),{transcription:e}}pushSignal(e){this.signal.push(e);let r=Number.MIN_VALUE;for(const s of e)s>r&&(r=s);return{numSamples:e.length}}})})();