var D=Symbol("Comlink.proxy"),G=Symbol("Comlink.endpoint"),W=Symbol("Comlink.releaseProxy"),R=Symbol("Comlink.finalizer"),T=Symbol("Comlink.thrown"),q=t=>typeof t=="object"&&t!==null||typeof t=="function",B={canHandle:t=>q(t)&&t[D],serialize(t){let{port1:e,port2:n}=new MessageChannel;return F(t,e),[n,[n]]},deserialize(t){return t.start(),Q(t)}},Z={canHandle:t=>q(t)&&T in t,serialize({value:t}){let e;return t instanceof Error?e={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:e={isError:!1,value:t},[e,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},U=new Map([["proxy",B],["throw",Z]]);function K(t,e){for(let n of t)if(e===n||n==="*"||n instanceof RegExp&&n.test(e))return!0;return!1}function F(t,e=globalThis,n=["*"]){e.addEventListener("message",function s(i){if(!i||!i.data)return;if(!K(n,i.origin)){console.warn(`Invalid origin '${i.origin}' for comlink proxy`);return}let{id:r,type:c,path:o}=Object.assign({path:[]},i.data),l=(i.data.argumentList||[]).map(p),a;try{let u=o.slice(0,-1).reduce((m,h)=>m[h],t),f=o.reduce((m,h)=>m[h],t);switch(c){case"GET":a=f;break;case"SET":u[o.slice(-1)[0]]=p(i.data.value),a=!0;break;case"APPLY":a=f.apply(u,l);break;case"CONSTRUCT":{let m=new f(...l);a=te(m)}break;case"ENDPOINT":{let{port1:m,port2:h}=new MessageChannel;F(t,h),a=ee(m,[m])}break;case"RELEASE":a=void 0;break;default:return}}catch(u){a={value:u,[T]:0}}Promise.resolve(a).catch(u=>({value:u,[T]:0})).then(u=>{let[f,m]=w(u);e.postMessage(Object.assign(Object.assign({},f),{id:r}),m),c==="RELEASE"&&(e.removeEventListener("message",s),O(e),R in t&&typeof t[R]=="function"&&t[R]())}).catch(u=>{let[f,m]=w({value:new TypeError("Unserializable return value"),[T]:0});e.postMessage(Object.assign(Object.assign({},f),{id:r}),m)})}),e.start&&e.start()}function X(t){return t.constructor.name==="MessagePort"}function O(t){X(t)&&t.close()}function Q(t,e){let n=new Map;return t.addEventListener("message",function(i){let{data:r}=i;if(!r||!r.id)return;let c=n.get(r.id);if(c)try{c(r)}finally{n.delete(r.id)}}),I(t,n,[],e)}function y(t){if(t)throw new Error("Proxy has been released and is not useable")}function z(t){return d(t,new Map,{type:"RELEASE"}).then(()=>{O(t)})}var k=new WeakMap,A="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{let e=(k.get(t)||0)-1;k.set(t,e),e===0&&z(t)});function Y(t,e){let n=(k.get(e)||0)+1;k.set(e,n),A&&A.register(t,e,t)}function $(t){A&&A.unregister(t)}function I(t,e,n=[],s=function(){}){let i=!1,r=new Proxy(s,{get(c,o){if(y(i),o===W)return()=>{$(r),z(t),e.clear(),i=!0};if(o==="then"){if(n.length===0)return{then:()=>r};let l=d(t,e,{type:"GET",path:n.map(a=>a.toString())}).then(p);return l.then.bind(l)}return I(t,e,[...n,o])},set(c,o,l){y(i);let[a,u]=w(l);return d(t,e,{type:"SET",path:[...n,o].map(f=>f.toString()),value:a},u).then(p)},apply(c,o,l){y(i);let a=n[n.length-1];if(a===G)return d(t,e,{type:"ENDPOINT"}).then(p);if(a==="bind")return I(t,e,n.slice(0,-1));let[u,f]=_(l);return d(t,e,{type:"APPLY",path:n.map(m=>m.toString()),argumentList:u},f).then(p)},construct(c,o){y(i);let[l,a]=_(o);return d(t,e,{type:"CONSTRUCT",path:n.map(u=>u.toString()),argumentList:l},a).then(p)}});return Y(r,t),r}function J(t){return Array.prototype.concat.apply([],t)}function _(t){let e=t.map(w);return[e.map(n=>n[0]),J(e.map(n=>n[1]))]}var j=new WeakMap;function ee(t,e){return j.set(t,e),t}function te(t){return Object.assign(t,{[D]:!0})}function w(t){for(let[e,n]of U)if(n.canHandle(t)){let[s,i]=n.serialize(t);return[{type:"HANDLER",name:e,value:s},i]}return[{type:"RAW",value:t},j.get(t)||[]]}function p(t){switch(t.type){case"HANDLER":return U.get(t.name).deserialize(t.value);case"RAW":return t.value}}function d(t,e,n,s){return new Promise(i=>{let r=ne();e.set(r,i),t.start&&t.start(),t.postMessage(Object.assign({id:r},n),s)})}function ne(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}var N=class{static calculatePeak(e,n,s){let i=[];for(let r of e){let c=!1;for(let o=0;o<i.length;o++){let l=i[o],a=l.value*(1+n),u=l.value*(1-n);if(r>=u&&r<=a){c=!0,l.count+=2,l.value=(l.value*(l.count-1)+r)/l.count,i[o]=l;break}}c||i.push({value:r,count:1})}i.sort((r,c)=>c.count-r.count);for(let r of i){let c=r.value;if(c>=s)return c}return s}};var M=class t{static mikelsFrequency(e,n,s){let i=0,c=t.calculatePeaks(e,2,e.length,0);c.sort((m,h)=>e[h]-e[m]);let o=5,l=10,a=0,u=0,f=n/s;for(let m=0;m<o;m++){let h=c[m],v=0;for(let P=0;P<l;P++){let x=h+P*h,H=x-2,V=x+2,L=-1;for(let g=H;g<=V;g++)g<e.length&&e[g]>L&&(L=e[g]);v+=L}v>a&&(a=v,u=h)}return i=u*f,i}static calculatePeaks(e,n,s,i){let r=0;if(i>0)for(let o=0;o<s;o++)e[o]>r&&(r=e[o]);r*=i;let c=[];if(s>=n)for(let o=n;o<s-n;o++){let l=!0;if(e[o]>=r){for(let a=0;a<n;a++)if(e[o]<e[o-a]||e[o]<e[o+a]){l=!1;break}}else l=!1;l&&c.push(o)}return c}};var b=1.05946309436,re=b*b,ie=33,se=87,oe=21,ae=["D","E","F","G","A","B","C","C","D","E","F","G","A","B","C","C","D","E","F","G","A","B","C","C","D","E","F","G","A","B","C","C","D"],ce={Bb:233.08,B:246.94,C:261.63,D:293.66,Eb:311.13,F:349.23,G:392};var S=class t{fundamentalFrequency;pitchModel;knownFrequencies;midiNotes;constructor(e="D",n="major"){this.fundamentalFrequency=ce[e],this.pitchModel=0,this.knownFrequencies=new Array(ie),this.midiNotes=new Array(se),this.makeScale(n),this.makeMidiNotes()}makeScale(e){let n=[1,2,4,5];if(e=="major"){this.pitchModel==0?this.knownFrequencies[0]=this.fundamentalFrequency/Math.pow(b,12):this.knownFrequencies[0]=this.fundamentalFrequency;for(let s=1;s<this.knownFrequencies.length;s++)t.isWholeToneInterval(s,n)?this.knownFrequencies[s]=this.knownFrequencies[s-1]*re:this.knownFrequencies[s]=this.knownFrequencies[s-1]*b}}static isWholeToneInterval(e,n){return e%=8,n.some(s=>s==e)}makeMidiNotes(){this.midiNotes[0]=27.5;for(let e=1;e<this.midiNotes.length;e++)this.midiNotes[e]=this.midiNotes[e-1]*b}spellFrequency(e){let n=0,s=Number.MAX_VALUE;if(e<this.knownFrequencies[0]||e>this.knownFrequencies.slice(-1)[0])return"Z";for(let i=0;i<this.knownFrequencies.length;i++){let r=Math.abs(e-this.knownFrequencies[i]);r<s&&(n=i,s=r)}return ae[n]}spellFrequencyAsMidi(e){let n=0,s=Number.MAX_VALUE;if(e<this.midiNotes[0]||e>this.midiNotes.slice(-1)[0])return"Z";for(let i=0;i<this.midiNotes.length;i++){let r=Math.abs(e-this.midiNotes[i]);r<s&&(n=i,s=r)}return n+=oe,n.toString()}};var le=44100,ue=4096,me=12,fe=0,he=20/1e3,pe="D",E=class{inputSampleRate;sampleTime;blankTime;tickTime;fundamental;frameSize;constructor(e){this.inputSampleRate=e.inputSampleRate||le,this.sampleTime=e.sampleTime||me,this.blankTime=e.blankTime||fe,this.tickTime=e.tickTime||he,this.fundamental=e.fundamental||pe,this.frameSize=e.frameSize||ue}transcribe(e){let n=new S(this.fundamental),s=[],i="",r=0;for(let o of e){let l=o.map(f=>this.decibelToLinear(f)),a=M.mikelsFrequency(Array.from(l),this.inputSampleRate,this.frameSize),u=n.spellFrequency(a);if(u!=i){i=u;let f={spelling:u,frequency:a,onset:r};s.push(f)}r+=this.tickTime}return this.postProcess(s)}postProcess(e){let n="";for(let r=0;r<e.length-1;r++)e[r].duration=e[r+1].onset-e[r].onset,e[r].duration<0&&console.log(e[r+1].onset,e[r].onset);e.slice(-1)[0].duration=this.blankTime+this.sampleTime-e.slice(-1)[0].onset;let s=new Array(e.length);for(let r=0;r<e.length;r++)s[r]=e[r].duration;let i=N.calculatePeak(s,.33,.1);for(let r of e){if(r.spelling=="Z")continue;r.quavers=Math.round(r.duration/i);let c=r.spelling;c=c.repeat(r.quavers),n+=c}return n}decibelToLinear(e){return Math.pow(10,e/20)}};var C=class{transcriber;signal;initialize(e){this.transcriber=new E(e),this.resetSignal()}resetSignal(){this.signal=[]}transcribe(){let e=this.transcriber.transcribe(this.signal);return console.log(`transcription: ${e}`),{transcription:e}}pushSignal(e){this.signal.push(e);let n=Number.MIN_VALUE;for(let s of e)s>n&&(n=s);return{numSamples:e.length}}},de=new C;F(de);export{C as TranscriberImpl};
