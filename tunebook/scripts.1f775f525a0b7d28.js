var DSP={LEFT:0,RIGHT:1,MIX:2,SINE:1,TRIANGLE:2,SAW:3,SQUARE:4,LOWPASS:0,HIGHPASS:1,BANDPASS:2,NOTCH:3,BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10,OFF:0,FW:1,BW:2,FWBW:3,TWO_PI:2*Math.PI};function setupTypedArray(s,a){"function"!=typeof this[s]&&"object"!=typeof this[s]&&(this[s]="function"==typeof this[a]&&"object"!=typeof this[a]?this[a]:function(t){return t instanceof Array?t:"number"==typeof t?new Array(t):void 0})}function FourierTransform(s,a){this.bufferSize=s,this.sampleRate=a,this.bandwidth=2/s*a/2,this.spectrum=new Float32Array(s/2),this.real=new Float32Array(s),this.imag=new Float32Array(s),this.peakBand=0,this.peak=0,this.getBandFrequency=function(t){return this.bandwidth*t+this.bandwidth/2},this.calculateSpectrum=function(){for(var n,p,l,t=this.spectrum,i=this.real,e=this.imag,h=2/this.bufferSize,r=Math.sqrt,o=0,m=s/2;o<m;o++)(l=h*r((n=i[o])*n+(p=e[o])*p))>this.peak&&(this.peakBand=o,this.peak=l),t[o]=l;return t}}function DFT(s,a){FourierTransform.call(this,s,a);var t=s/2*s,i=2*Math.PI;this.sinTable=new Float32Array(t),this.cosTable=new Float32Array(t);for(var e=0;e<t;e++)this.sinTable[e]=Math.sin(e*i/s),this.cosTable[e]=Math.cos(e*i/s)}function FFT(s,a){FourierTransform.call(this,s,a),this.reverseTable=new Uint32Array(s);for(var e,t=1,i=s>>1;t<s;){for(e=0;e<t;e++)this.reverseTable[e+t]=this.reverseTable[e]+i;t<<=1,i>>=1}for(this.sinTable=new Float32Array(s),this.cosTable=new Float32Array(s),e=0;e<s;e++)this.sinTable[e]=Math.sin(-Math.PI/e),this.cosTable[e]=Math.cos(-Math.PI/e)}function RFFT(s,a){FourierTransform.call(this,s,a),this.trans=new Float32Array(s),this.reverseTable=new Uint32Array(s),this.reverseBinPermute=function(t,i,e){var o,h=this.bufferSize,r=h>>>1,n=h-1,p=1,l=0;t[0]=i[e=void 0!==e?e:0];do{for(t[p]=i[e+(l+=r)],t[l]=i[e+p],p++,o=r<<1;!((l^=o>>=1)&o););l>=p&&(t[p]=i[e+l],t[l]=i[e+p],t[n-p]=i[e+n-l],t[n-l]=i[e+n-p]),p++}while(p<r);t[n]=i[e+n]},this.generateReverseTable=function(){var n,t=this.bufferSize,i=t>>>1,e=t-1,h=1,r=0;this.reverseTable[0]=0;do{for(this.reverseTable[h]=r+=i,this.reverseTable[r]=h,h++,n=i<<1;!((r^=n>>=1)&n););r>=h&&(this.reverseTable[h]=r,this.reverseTable[r]=h,this.reverseTable[e-h]=e-r,this.reverseTable[e-r]=e-h),h++}while(h<i);this.reverseTable[e]=e},this.generateReverseTable()}function Sampler(s,a,t,i,e,h,r,n){this.file=s,this.bufferSize=a,this.sampleRate=t,this.playStart=i||0,this.playEnd=e||1,this.loopStart=h||0,this.loopEnd=r||1,this.loopMode=n||DSP.OFF,this.loaded=!1,this.samples=[],this.signal=new Float32Array(a),this.frameCount=0,this.envelope=null,this.amplitude=1,this.rootFrequency=110,this.frequency=550,this.step=this.frequency/this.rootFrequency,this.duration=0,this.samplesProcessed=0,this.playhead=0;var p=document.createElement("AUDIO"),l=this;this.loadSamples=function(o){for(var m=DSP.getChannel(DSP.MIX,o.frameBuffer),v=0;v<m.length;v++)l.samples.push(m[v])},this.loadComplete=function(){l.samples=new Float32Array(l.samples),l.loaded=!0},this.loadMetaData=function(){l.duration=p.duration},p.addEventListener("MozAudioAvailable",this.loadSamples,!1),p.addEventListener("loadedmetadata",this.loadMetaData,!1),p.addEventListener("ended",this.loadComplete,!1),p.muted=!0,p.src=s,p.play()}function Oscillator(s,a,t,i,e){switch(this.frequency=a,this.amplitude=t,this.bufferSize=i,this.sampleRate=e,this.frameCount=0,this.waveTableLength=2048,this.cyclesPerSample=a/e,this.signal=new Float32Array(i),this.envelope=null,parseInt(s,10)){case DSP.TRIANGLE:this.func=Oscillator.Triangle;break;case DSP.SAW:this.func=Oscillator.Saw;break;case DSP.SQUARE:this.func=Oscillator.Square;break;default:this.func=Oscillator.Sine}this.generateWaveTable=function(){Oscillator.waveTable[this.func]=new Float32Array(2048);for(var r=1/(this.waveTableLength/this.sampleRate),n=0;n<this.waveTableLength;n++)Oscillator.waveTable[this.func][n]=this.func(n*r/this.sampleRate)},void 0===Oscillator.waveTable&&(Oscillator.waveTable={}),void 0===Oscillator.waveTable[this.func]&&this.generateWaveTable(),this.waveTable=Oscillator.waveTable[this.func]}function ADSR(s,a,t,i,e,h){this.sampleRate=h,this.attackLength=s,this.decayLength=a,this.sustainLevel=t,this.sustainLength=i,this.releaseLength=e,this.sampleRate=h,this.attackSamples=s*h,this.decaySamples=a*h,this.sustainSamples=i*h,this.releaseSamples=e*h,this.update=function(){this.attack=this.attackSamples,this.decay=this.attack+this.decaySamples,this.sustain=this.decay+this.sustainSamples,this.release=this.sustain+this.releaseSamples},this.update(),this.samplesProcessed=0}function IIRFilter(s,a,t,i){switch(this.sampleRate=i,s){case DSP.LOWPASS:case DSP.LP12:this.func=new IIRFilter.LP12(a,t,i)}}function IIRFilter2(s,a,t,i){this.type=s,this.cutoff=a,this.resonance=t,this.sampleRate=i,this.f=Float32Array(4),this.f[0]=0,this.f[1]=0,this.f[2]=0,this.f[3]=0,this.calcCoeff=function(e,h){this.freq=2*Math.sin(Math.PI*Math.min(.25,e/(2*this.sampleRate))),this.damp=Math.min(2*(1-Math.pow(h,.25)),Math.min(2,2/this.freq-.5*this.freq))},this.calcCoeff(a,t)}function WindowFunction(s,a){switch(this.alpha=a,s){case DSP.BARTLETT:this.func=WindowFunction.Bartlett;break;case DSP.BARTLETTHANN:this.func=WindowFunction.BartlettHann;break;case DSP.BLACKMAN:this.func=WindowFunction.Blackman,this.alpha=this.alpha||.16;break;case DSP.COSINE:this.func=WindowFunction.Cosine;break;case DSP.GAUSS:this.func=WindowFunction.Gauss,this.alpha=this.alpha||.25;break;case DSP.HAMMING:this.func=WindowFunction.Hamming;break;case DSP.HANN:this.func=WindowFunction.Hann;break;case DSP.LANCZOS:this.func=WindowFunction.Lanczoz;break;case DSP.RECTANGULAR:this.func=WindowFunction.Rectangular;break;case DSP.TRIANGULAR:this.func=WindowFunction.Triangular}}function sinh(s){return(Math.exp(s)-Math.exp(-s))/2}function Biquad(s,a){this.Fs=a,this.type=s,this.parameterType=DSP.Q,this.x_1_l=0,this.x_2_l=0,this.y_1_l=0,this.y_2_l=0,this.x_1_r=0,this.x_2_r=0,this.y_1_r=0,this.y_2_r=0,this.b0=1,this.a0=1,this.b1=0,this.a1=0,this.b2=0,this.a2=0,this.b0a0=this.b0/this.a0,this.b1a0=this.b1/this.a0,this.b2a0=this.b2/this.a0,this.a1a0=this.a1/this.a0,this.a2a0=this.a2/this.a0,this.f0=3e3,this.dBgain=12,this.Q=1,this.BW=-3,this.S=1,this.coefficients=function(){return{b:[this.b0,this.b1,this.b2],a:[this.a0,this.a1,this.a2]}},this.setFilterType=function(t){this.type=t,this.recalculateCoefficients()},this.setSampleRate=function(t){this.Fs=t,this.recalculateCoefficients()},this.setQ=function(t){this.parameterType=DSP.Q,this.Q=Math.max(Math.min(t,115),.001),this.recalculateCoefficients()},this.setBW=function(t){this.parameterType=DSP.BW,this.BW=t,this.recalculateCoefficients()},this.setS=function(t){this.parameterType=DSP.S,this.S=Math.max(Math.min(t,5),1e-4),this.recalculateCoefficients()},this.setF0=function(t){this.f0=t,this.recalculateCoefficients()},this.setDbGain=function(t){this.dBgain=t,this.recalculateCoefficients()},this.recalculateCoefficients=function(){var t;t=s===DSP.PEAKING_EQ||s===DSP.LOW_SHELF||s===DSP.HIGH_SHELF?Math.pow(10,this.dBgain/40):Math.sqrt(Math.pow(10,this.dBgain/20));var n,i=DSP.TWO_PI*this.f0/this.Fs,e=Math.cos(i),h=Math.sin(i),r=0;switch(this.parameterType){case DSP.Q:r=h/(2*this.Q);break;case DSP.BW:r=h*sinh(Math.LN2/2*this.BW*i/h);break;case DSP.S:r=h/2*Math.sqrt((t+1/t)*(1/this.S-1)+2)}switch(this.type){case DSP.LPF:this.b0=(1-e)/2,this.b1=1-e,this.b2=(1-e)/2,this.a0=1+r,this.a1=-2*e,this.a2=1-r;break;case DSP.HPF:this.b0=(1+e)/2,this.b1=-(1+e),this.b2=(1+e)/2,this.a0=1+r,this.a1=-2*e,this.a2=1-r;break;case DSP.BPF_CONSTANT_SKIRT:this.b0=h/2,this.b1=0,this.b2=-h/2,this.a0=1+r,this.a1=-2*e,this.a2=1-r;break;case DSP.BPF_CONSTANT_PEAK:this.b0=r,this.b1=0,this.b2=-r,this.a0=1+r,this.a1=-2*e,this.a2=1-r;break;case DSP.NOTCH:this.b0=1,this.b1=-2*e,this.b2=1,this.a0=1+r,this.a1=-2*e,this.a2=1-r;break;case DSP.APF:this.b0=1-r,this.b1=-2*e,this.b2=1+r,this.a0=1+r,this.a1=-2*e,this.a2=1-r;break;case DSP.PEAKING_EQ:this.b0=1+r*t,this.b1=-2*e,this.b2=1-r*t,this.a0=1+r/t,this.a1=-2*e,this.a2=1-r/t;break;case DSP.LOW_SHELF:n=h*Math.sqrt((3^t)*(1/this.S-1)+2*t),this.b0=t*(t+1-(t-1)*e+n),this.b1=2*t*(t-1-(t+1)*e),this.b2=t*(t+1-(t-1)*e-n),this.a0=t+1+(t-1)*e+n,this.a1=-2*(t-1+(t+1)*e),this.a2=t+1+(t-1)*e-n;break;case DSP.HIGH_SHELF:n=h*Math.sqrt((3^t)*(1/this.S-1)+2*t),this.b0=t*(t+1+(t-1)*e+n),this.b1=-2*t*(t-1+(t+1)*e),this.b2=t*(t+1+(t-1)*e-n),this.a0=t+1-(t-1)*e+n,this.a1=2*(t-1-(t+1)*e),this.a2=t+1-(t-1)*e-n}this.b0a0=this.b0/this.a0,this.b1a0=this.b1/this.a0,this.b2a0=this.b2/this.a0,this.a1a0=this.a1/this.a0,this.a2a0=this.a2/this.a0},this.process=function(t){for(var e=new Float32Array(t.length),h=0;h<t.length;h++)e[h]=this.b0a0*t[h]+this.b1a0*this.x_1_l+this.b2a0*this.x_2_l-this.a1a0*this.y_1_l-this.a2a0*this.y_2_l,this.y_2_l=this.y_1_l,this.y_1_l=e[h],this.x_2_l=this.x_1_l,this.x_1_l=t[h];return e},this.processStereo=function(t){for(var i=t.length,e=new Float32Array(i),h=0;h<i/2;h++)e[2*h]=this.b0a0*t[2*h]+this.b1a0*this.x_1_l+this.b2a0*this.x_2_l-this.a1a0*this.y_1_l-this.a2a0*this.y_2_l,this.y_2_l=this.y_1_l,this.y_1_l=e[2*h],this.x_2_l=this.x_1_l,this.x_1_l=t[2*h],e[2*h+1]=this.b0a0*t[2*h+1]+this.b1a0*this.x_1_r+this.b2a0*this.x_2_r-this.a1a0*this.y_1_r-this.a2a0*this.y_2_r,this.y_2_r=this.y_1_r,this.y_1_r=e[2*h+1],this.x_2_r=this.x_1_r,this.x_1_r=t[2*h+1];return e}}function GraphicalEq(s){this.FS=s,this.minFreq=40,this.maxFreq=16e3,this.bandsPerOctave=1,this.filters=[],this.freqzs=[],this.calculateFreqzs=!0,this.recalculateFilters=function(){var a=Math.round(Math.log(this.maxFreq/this.minFreq)*this.bandsPerOctave/Math.LN2);this.filters=[];for(var t=0;t<a;t++){var i=this.minFreq*Math.pow(2,t/this.bandsPerOctave),e=new Biquad(DSP.PEAKING_EQ,this.FS);e.setDbGain(0),e.setBW(1/this.bandsPerOctave),e.setF0(i),this.filters[t]=e,this.recalculateFreqz(t)}},this.setMinimumFrequency=function(a){this.minFreq=a,this.recalculateFilters()},this.setMaximumFrequency=function(a){this.maxFreq=a,this.recalculateFilters()},this.setBandsPerOctave=function(a){this.bandsPerOctave=a,this.recalculateFilters()},this.setBandGain=function(a,t){if(a<0||a>this.filters.length-1)throw"The band index of the graphical equalizer is out of bounds.";if(!t)throw"A gain must be passed.";this.filters[a].setDbGain(t),this.recalculateFreqz(a)},this.recalculateFreqz=function(a){if(this.calculateFreqzs){if(a<0||a>this.filters.length-1)throw"The band index of the graphical equalizer is out of bounds. "+a+" is out of [0, "+this.filters.length-1+"]";if(!this.w){this.w=Float32Array(400);for(var t=0;t<this.w.length;t++)this.w[t]=Math.PI/this.w.length*t}this.freqzs[a]=DSP.mag2db(DSP.freqz([this.filters[a].b0,this.filters[a].b1,this.filters[a].b2],[this.filters[a].a0,this.filters[a].a1,this.filters[a].a2],this.w))}},this.process=function(a){for(var t=a,i=0;i<this.filters.length;i++)t=this.filters[i].process(t);return t},this.processStereo=function(a){for(var t=a,i=0;i<this.filters.length;i++)t=this.filters[i].processStereo(t);return t}}function MultiDelay(s,a,t,i){this.delayBufferSamples=new Float32Array(s),this.delayInputPointer=a,this.delayOutputPointer=0,this.delayInSamples=a,this.masterVolume=t,this.delayVolume=i}function SingleDelay(s,a,t){this.delayBufferSamples=new Float32Array(s),this.delayInputPointer=a,this.delayOutputPointer=0,this.delayInSamples=a,this.delayVolume=t}function Reverb(s,a,t,i,e,h){var r,n;for(this.delayInSamples=a,this.masterVolume=t,this.mixVolume=i,this.delayVolume=e,this.dampFrequency=h,this.NR_OF_MULTIDELAYS=6,this.NR_OF_SINGLEDELAYS=6,this.LOWPASSL=new IIRFilter2(DSP.LOWPASS,h,0,44100),this.LOWPASSR=new IIRFilter2(DSP.LOWPASS,h,0,44100),this.singleDelays=[],r=0;r<this.NR_OF_SINGLEDELAYS;r++)n=1+r/7,this.singleDelays[r]=new SingleDelay(s,Math.round(this.delayInSamples*n),this.delayVolume);for(this.multiDelays=[],r=0;r<this.NR_OF_MULTIDELAYS;r++)n=1+r/10,this.multiDelays[r]=new MultiDelay(s,Math.round(this.delayInSamples*n),this.masterVolume,this.delayVolume)}setupTypedArray("Float32Array","WebGLFloatArray"),setupTypedArray("Int32Array","WebGLIntArray"),setupTypedArray("Uint16Array","WebGLUnsignedShortArray"),setupTypedArray("Uint8Array","WebGLUnsignedByteArray"),DSP.invert=function(s){for(var a=0,t=s.length;a<t;a++)s[a]*=-1;return s},DSP.interleave=function(s,a){if(s.length!==a.length)throw"Can not interleave. Channel lengths differ.";for(var t=new Float32Array(2*s.length),i=0,e=s.length;i<e;i++)t[2*i]=s[i],t[2*i+1]=a[i];return t},DSP.deinterleave=function(){var s,a,t,i=[];return i[DSP.MIX]=function(e){for(var h=0,r=e.length/2;h<r;h++)t[h]=(e[2*h]+e[2*h+1])/2;return t},i[DSP.LEFT]=function(e){for(var h=0,r=e.length/2;h<r;h++)s[h]=e[2*h];return s},i[DSP.RIGHT]=function(e){for(var h=0,r=e.length/2;h<r;h++)a[h]=e[2*h+1];return a},function(e,h){return s=s||new Float32Array(h.length/2),a=a||new Float32Array(h.length/2),t=t||new Float32Array(h.length/2),h.length/2!==s.length&&(s=new Float32Array(h.length/2),a=new Float32Array(h.length/2),t=new Float32Array(h.length/2)),i[e](h)}}(),DSP.getChannel=DSP.deinterleave,DSP.mixSampleBuffers=function(s,a,t,i){for(var e=new Float32Array(s),h=0;h<s.length;h++)e[h]+=(t?-a[h]:a[h])/i;return e},DSP.LPF=0,DSP.HPF=1,DSP.BPF_CONSTANT_SKIRT=2,DSP.BPF_CONSTANT_PEAK=3,DSP.NOTCH=4,DSP.APF=5,DSP.PEAKING_EQ=6,DSP.LOW_SHELF=7,DSP.HIGH_SHELF=8,DSP.Q=1,DSP.BW=2,DSP.S=3,DSP.RMS=function(s){for(var a=0,t=0,i=s.length;t<i;t++)a+=s[t]*s[t];return Math.sqrt(a/i)},DSP.Peak=function(s){for(var a=0,t=0,i=s.length;t<i;t++)a=Math.abs(s[t])>a?Math.abs(s[t]):a;return a},DFT.prototype.forward=function(s){for(var i,e,a=this.real,t=this.imag,h=0;h<this.bufferSize/2;h++){i=0,e=0;for(var r=0;r<s.length;r++)i+=this.cosTable[h*r]*s[r],e+=this.sinTable[h*r]*s[r];a[h]=i,t[h]=e}return this.calculateSpectrum()},FFT.prototype.forward=function(s){var a=this.bufferSize,t=this.cosTable,i=this.sinTable,e=this.reverseTable,h=this.real,r=this.imag,p=Math.floor(Math.log(a)/Math.LN2);if(Math.pow(2,p)!==a)throw"Invalid buffer size, must be a power of 2.";if(a!==s.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+a+" Buffer Size: "+s.length;var o,m,v,f,S,b,u,d,c,l=1;for(c=0;c<a;c++)h[c]=s[e[c]],r[c]=0;for(;l<a;){o=t[l],m=i[l],v=1,f=0;for(var y=0;y<l;y++){for(c=y;c<a;)u=v*r[S=c+l]+f*h[S],h[S]=h[c]-(b=v*h[S]-f*r[S]),r[S]=r[c]-u,h[c]+=b,r[c]+=u,c+=l<<1;v=(d=v)*o-f*m,f=d*m+f*o}l<<=1}return this.calculateSpectrum()},FFT.prototype.inverse=function(s,a){var t=this.bufferSize,i=this.cosTable,e=this.sinTable,h=this.reverseTable;s=s||this.real,a=a||this.imag;var p,l,o,m,v,f,S,b,u,n=1;for(u=0;u<t;u++)a[u]*=-1;var d=new Float32Array(t),c=new Float32Array(t);for(u=0;u<s.length;u++)d[u]=s[h[u]],c[u]=a[h[u]];for(s=d,a=c;n<t;){p=i[n],l=e[n],o=1,m=0;for(var y=0;y<n;y++){for(u=y;u<t;)S=o*a[v=u+n]+m*s[v],s[v]=s[u]-(f=o*s[v]-m*a[v]),a[v]=a[u]-S,s[u]+=f,a[u]+=S,u+=n<<1;o=(b=o)*p-m*l,m=b*l+m*p}n<<=1}var g=new Float32Array(t);for(u=0;u<t;u++)g[u]=s[u]/t;return g},RFFT.prototype.forward=function(s,a){a=void 0!==a?a:0;var l,o,m,v,f,S,b,u,d,c,y,g,O,w,I,E,F,M,A,B,N,W,q,k,D,R,t=this.bufferSize,i=this.spectrum,e=this.trans,h=2*Math.PI,r=Math.sqrt,n=t>>>1,p=2/t;this.reverseBinPermute(e,s,a);for(var _=0,T=4;_<t;T*=4){for(var P=_;P<t;P+=T)F=e[P]-e[P+1],e[P]+=e[P+1],e[P+1]=F;_=2*(T-1)}for(l=2,v=t>>>1;v>>>=1;){_=0,T=(l<<=1)<<1,o=l>>>2,m=l>>>3;do{if(1!==o)for(P=_;P<t;P+=T)f=e[y=(c=(d=P)+o)+o]+e[g=y+o],e[g]-=e[y],e[y]=e[d]-f,e[d]+=f,d+=m,c+=m,S=e[y+=m]-e[g+=m],f=-(f=e[y]+e[g])*Math.SQRT1_2,S*=Math.SQRT1_2,e[g]=f+(F=e[c]),e[y]=f-F,e[c]=e[d]-S,e[d]+=S;else for(P=_;P<t;P+=T)f=e[y=(c=(d=P)+o)+o]+e[g=y+o],e[g]-=e[y],e[y]=e[d]-f,e[d]+=f;_=(T<<1)-l,T<<=2}while(_<t);W=h/l;for(var L=1;L<m;L++){q=L*W,A=Math.sin(q),B=4*(M=Math.cos(q))*(M*M-.75),N=4*A*(.75-A*A),_=0,T=l<<1;do{for(P=_;P<t;P+=T)f=e[I=(w=(O=P+o-L)+o)+o]*A+e[y=(c=(d=P+L)+o)+o]*M,b=e[E=I+o]*N+e[g=y+o]*B,F=(S=e[I]*M-e[y]*A)-(u=e[E]*B-e[g]*N),S+=u,u=F,e[E]=S+e[w],e[y]=S-e[w],F=b-f,f+=b,e[g]=(b=F)+e[c],e[I]=b-e[c],e[w]=e[d]-f,e[d]+=f,e[c]=u+e[O],e[O]-=u;_=(T<<1)-l,T<<=2}while(_<t)}}for(;--n;)(R=p*r((k=e[n])*k+(D=e[t-n-1])*D))>this.peak&&(this.peakBand=n,this.peak=R),i[n]=R;return i[0]=p*e[0],i},Sampler.prototype.applyEnvelope=function(){return this.envelope.process(this.signal),this.signal},Sampler.prototype.generate=function(){for(var a=this.playEnd*this.samples.length-this.playStart*this.samples.length,t=this.playStart*this.samples.length,i=this.playEnd*this.samples.length,h=0;h<this.bufferSize;h++){switch(this.loopMode){case DSP.OFF:this.playhead=Math.round(this.samplesProcessed*this.step+t),this.signal[h]=this.playhead<this.playEnd*this.samples.length?this.samples[this.playhead]*this.amplitude:0;break;case DSP.FW:this.playhead=Math.round(this.samplesProcessed*this.step%a+t),this.playhead<this.playEnd*this.samples.length&&(this.signal[h]=this.samples[this.playhead]*this.amplitude);break;case DSP.BW:this.playhead=i-Math.round(this.samplesProcessed*this.step%a),this.playhead<this.playEnd*this.samples.length&&(this.signal[h]=this.samples[this.playhead]*this.amplitude);break;case DSP.FWBW:this.playhead=Math.floor(this.samplesProcessed*this.step/a)%2==0?Math.round(this.samplesProcessed*this.step%a+t):i-Math.round(this.samplesProcessed*this.step%a),this.playhead<this.playEnd*this.samples.length&&(this.signal[h]=this.samples[this.playhead]*this.amplitude)}this.samplesProcessed++}return this.frameCount++,this.signal},Sampler.prototype.setFreq=function(s){var a=this.samplesProcessed*this.step;this.frequency=s,this.step=this.frequency/this.rootFrequency,this.samplesProcessed=Math.round(a/this.step)},Sampler.prototype.reset=function(){this.samplesProcessed=0,this.playhead=0},Oscillator.prototype.setAmp=function(s){if(!(s>=0&&s<=1))throw"Amplitude out of range (0..1).";this.amplitude=s},Oscillator.prototype.setFreq=function(s){this.frequency=s,this.cyclesPerSample=s/this.sampleRate},Oscillator.prototype.add=function(s){for(var a=0;a<this.bufferSize;a++)this.signal[a]+=s.signal[a];return this.signal},Oscillator.prototype.addSignal=function(s){for(var a=0;a<s.length&&!(a>=this.bufferSize);a++)this.signal[a]+=s[a];return this.signal},Oscillator.prototype.addEnvelope=function(s){this.envelope=s},Oscillator.prototype.applyEnvelope=function(){this.envelope.process(this.signal)},Oscillator.prototype.valueAt=function(s){return this.waveTable[s%this.waveTableLength]},Oscillator.prototype.generate=function(){for(var t,s=this.frameCount*this.bufferSize,a=this.waveTableLength*this.frequency/this.sampleRate,i=0;i<this.bufferSize;i++)t=Math.round((s+i)*a),this.signal[i]=this.waveTable[t%this.waveTableLength]*this.amplitude;return this.frameCount++,this.signal},Oscillator.Sine=function(s){return Math.sin(DSP.TWO_PI*s)},Oscillator.Square=function(s){return s<.5?1:-1},Oscillator.Saw=function(s){return 2*(s-Math.round(s))},Oscillator.Triangle=function(s){return 1-4*Math.abs(Math.round(s)-s)},Oscillator.Pulse=function(s){},ADSR.prototype.noteOn=function(){this.samplesProcessed=0,this.sustainSamples=this.sustainLength*this.sampleRate,this.update()},ADSR.prototype.noteOff=function(){this.sustainSamples=this.samplesProcessed-this.decaySamples,this.update()},ADSR.prototype.processSample=function(s){var a=0;return this.samplesProcessed<=this.attack?a=0+(this.samplesProcessed-0)/(this.attack-0)*1:this.samplesProcessed>this.attack&&this.samplesProcessed<=this.decay?a=1+(this.samplesProcessed-this.attack)/(this.decay-this.attack)*(this.sustainLevel-1):this.samplesProcessed>this.decay&&this.samplesProcessed<=this.sustain?a=this.sustainLevel:this.samplesProcessed>this.sustain&&this.samplesProcessed<=this.release&&(a=this.sustainLevel+(this.samplesProcessed-this.sustain)/(this.release-this.sustain)*(0-this.sustainLevel)),s*a},ADSR.prototype.value=function(){var s=0;return this.samplesProcessed<=this.attack?s=0+(this.samplesProcessed-0)/(this.attack-0)*1:this.samplesProcessed>this.attack&&this.samplesProcessed<=this.decay?s=1+(this.samplesProcessed-this.attack)/(this.decay-this.attack)*(this.sustainLevel-1):this.samplesProcessed>this.decay&&this.samplesProcessed<=this.sustain?s=this.sustainLevel:this.samplesProcessed>this.sustain&&this.samplesProcessed<=this.release&&(s=this.sustainLevel+(this.samplesProcessed-this.sustain)/(this.release-this.sustain)*(0-this.sustainLevel)),s},ADSR.prototype.process=function(s){for(var a=0;a<s.length;a++)s[a]*=this.value(),this.samplesProcessed++;return s},ADSR.prototype.isActive=function(){return!(this.samplesProcessed>this.release||-1===this.samplesProcessed)},ADSR.prototype.disable=function(){this.samplesProcessed=-1},IIRFilter.prototype.__defineGetter__("cutoff",function(){return this.func.cutoff}),IIRFilter.prototype.__defineGetter__("resonance",function(){return this.func.resonance}),IIRFilter.prototype.set=function(s,a){this.func.calcCoeff(s,a)},IIRFilter.prototype.process=function(s){this.func.process(s)},IIRFilter.prototype.addEnvelope=function(s){if(!(s instanceof ADSR))throw"Not an envelope.";this.func.addEnvelope(s)},IIRFilter.LP12=function(s,a,t){this.sampleRate=t,this.vibraPos=0,this.vibraSpeed=0,this.envelope=!1,this.calcCoeff=function(i,e){this.w=2*Math.PI*i/this.sampleRate,this.q=1-this.w/(2*(e+.5/(1+this.w))+this.w-2),this.r=this.q*this.q,this.c=this.r+1-2*Math.cos(this.w)*this.q,this.cutoff=i,this.resonance=e},this.calcCoeff(s,a),this.process=function(i){for(var e=0;e<i.length;e++)this.vibraSpeed+=(i[e]-this.vibraPos)*this.c,this.vibraPos+=this.vibraSpeed,this.vibraSpeed*=this.r,this.envelope?(i[e]=i[e]*(1-this.envelope.value())+this.vibraPos*this.envelope.value(),this.envelope.samplesProcessed++):i[e]=this.vibraPos}},IIRFilter.LP12.prototype.addEnvelope=function(s){this.envelope=s},IIRFilter2.prototype.process=function(s){for(var a,t,i=this.f,e=0;e<s.length;e++)i[3]=(a=s[e])-this.damp*i[2],i[0]=i[0]+this.freq*i[2],i[1]=i[3]-i[0],i[2]=this.freq*i[1]+i[2],t=.5*i[this.type],i[3]=a-this.damp*i[2],i[0]=i[0]+this.freq*i[2],i[1]=i[3]-i[0],i[2]=this.freq*i[1]+i[2],t+=.5*i[this.type],this.envelope?(s[e]=s[e]*(1-this.envelope.value())+t*this.envelope.value(),this.envelope.samplesProcessed++):s[e]=t},IIRFilter2.prototype.addEnvelope=function(s){if(!(s instanceof ADSR))throw"This is not an envelope.";this.envelope=s},IIRFilter2.prototype.set=function(s,a){this.calcCoeff(s,a)},WindowFunction.prototype.process=function(s,a,t){t=void 0!==t?t:s.length;for(var i=a=void 0!==a?a:0;i<t;i++)s[i]*=this.func(t,i,this.alpha);return s},WindowFunction.Bartlett=function(s,a){return 2/(s-1)*((s-1)/2-Math.abs(a-(s-1)/2))},WindowFunction.BartlettHann=function(s,a){return.62-.48*Math.abs(a/(s-1)-.5)-.38*Math.cos(DSP.TWO_PI*a/(s-1))},WindowFunction.Blackman=function(s,a,t){var h=t/2;return(1-t)/2-.5*Math.cos(DSP.TWO_PI*a/(s-1))+h*Math.cos(4*Math.PI*a/(s-1))},WindowFunction.Cosine=function(s,a){return Math.cos(Math.PI*a/(s-1)-Math.PI/2)},WindowFunction.Gauss=function(s,a,t){return Math.pow(Math.E,-.5*Math.pow((a-(s-1)/2)/(t*(s-1)/2),2))},WindowFunction.Hamming=function(s,a){return.54-.46*Math.cos(DSP.TWO_PI*a/(s-1))},WindowFunction.Hann=function(s,a){return.5*(1-Math.cos(DSP.TWO_PI*a/(s-1)))},WindowFunction.Lanczos=function(s,a){var t=2*a/(s-1)-1;return Math.sin(Math.PI*t)/(Math.PI*t)},WindowFunction.Rectangular=function(s,a){return 1},WindowFunction.Triangular=function(s,a){return 2/s*(s/2-Math.abs(a-(s-1)/2))},DSP.mag2db=function(s){for(var t=Math.pow(10,-6),i=Math.log,e=Math.max,h=Float32Array(s.length),r=0;r<s.length;r++)h[r]=20*i(e(s[r],t));return h},DSP.freqz=function(s,a,t){var i,e;if(!t)for(t=Float32Array(200),i=0;i<t.length;i++)t[i]=DSP.TWO_PI/t.length*i-Math.PI;var h=Float32Array(t.length),r=Math.sqrt,n=Math.cos,p=Math.sin;for(i=0;i<t.length;i++){var l={real:0,imag:0};for(e=0;e<s.length;e++)l.real+=s[e]*n(-e*t[i]),l.imag+=s[e]*p(-e*t[i]);var o={real:0,imag:0};for(e=0;e<a.length;e++)o.real+=a[e]*n(-e*t[i]),o.imag+=a[e]*p(-e*t[i]);h[i]=r(l.real*l.real+l.imag*l.imag)/r(o.real*o.real+o.imag*o.imag)}return h},MultiDelay.prototype.setDelayInSamples=function(s){this.delayInSamples=s,this.delayInputPointer=this.delayOutputPointer+s,this.delayInputPointer>=this.delayBufferSamples.length-1&&(this.delayInputPointer=this.delayInputPointer-this.delayBufferSamples.length)},MultiDelay.prototype.setMasterVolume=function(s){this.masterVolume=s},MultiDelay.prototype.setDelayVolume=function(s){this.delayVolume=s},MultiDelay.prototype.process=function(s){for(var a=new Float32Array(s.length),t=0;t<s.length;t++){var e=(null===this.delayBufferSamples[this.delayOutputPointer]?0:this.delayBufferSamples[this.delayOutputPointer])*this.delayVolume+s[t];this.delayBufferSamples[this.delayInputPointer]=e,a[t]=e*this.masterVolume,this.delayInputPointer++,this.delayInputPointer>=this.delayBufferSamples.length-1&&(this.delayInputPointer=0),this.delayOutputPointer++,this.delayOutputPointer>=this.delayBufferSamples.length-1&&(this.delayOutputPointer=0)}return a},SingleDelay.prototype.setDelayInSamples=function(s){this.delayInSamples=s,this.delayInputPointer=this.delayOutputPointer+s,this.delayInputPointer>=this.delayBufferSamples.length-1&&(this.delayInputPointer=this.delayInputPointer-this.delayBufferSamples.length)},SingleDelay.prototype.setDelayVolume=function(s){this.delayVolume=s},SingleDelay.prototype.process=function(s){for(var a=new Float32Array(s.length),t=0;t<s.length;t++)this.delayBufferSamples[this.delayInputPointer]=s[t],a[t]=this.delayBufferSamples[this.delayOutputPointer]*this.delayVolume,this.delayInputPointer++,this.delayInputPointer>=this.delayBufferSamples.length-1&&(this.delayInputPointer=0),this.delayOutputPointer++,this.delayOutputPointer>=this.delayBufferSamples.length-1&&(this.delayOutputPointer=0);return a},Reverb.prototype.setDelayInSamples=function(s){var a,t;for(this.delayInSamples=s,a=0;a<this.NR_OF_SINGLEDELAYS;a++)t=1+a/7,this.singleDelays[a].setDelayInSamples(Math.round(this.delayInSamples*t));for(a=0;a<this.NR_OF_MULTIDELAYS;a++)t=1+a/10,this.multiDelays[a].setDelayInSamples(Math.round(this.delayInSamples*t))},Reverb.prototype.setMasterVolume=function(s){this.masterVolume=s},Reverb.prototype.setMixVolume=function(s){this.mixVolume=s},Reverb.prototype.setDelayVolume=function(s){var a;for(this.delayVolume=s,a=0;a<this.NR_OF_SINGLEDELAYS;a++)this.singleDelays[a].setDelayVolume(this.delayVolume);for(a=0;a<this.NR_OF_MULTIDELAYS;a++)this.multiDelays[a].setDelayVolume(this.delayVolume)},Reverb.prototype.setDampFrequency=function(s){this.dampFrequency=s,this.LOWPASSL.set(s,0),this.LOWPASSR.set(s,0)},Reverb.prototype.process=function(s){var a=new Float32Array(s.length),t=DSP.deinterleave(s);this.LOWPASSL.process(t[DSP.LEFT]),this.LOWPASSR.process(t[DSP.RIGHT]);var e,i=DSP.interleave(t[DSP.LEFT],t[DSP.RIGHT]);for(e=0;e<this.NR_OF_MULTIDELAYS;e++)a=DSP.mixSampleBuffers(a,this.multiDelays[e].process(i),2%e==0,this.NR_OF_MULTIDELAYS);var h=new Float32Array(a.length);for(e=0;e<this.NR_OF_SINGLEDELAYS;e++)h=DSP.mixSampleBuffers(h,this.singleDelays[e].process(a),2%e==0,1);for(e=0;e<h.length;e++)h[e]*=this.mixVolume;for(a=DSP.mixSampleBuffers(h,s,0,1),e=0;e<a.length;e++)a[e]*=this.masterVolume;return a},"undefined"!=typeof module&&void 0!==module.exports&&(module.exports={DSP,DFT,FFT,RFFT,Sampler,Oscillator,ADSR,IIRFilter,IIRFilter2,WindowFunction,sinh,Biquad,GraphicalEq,MultiDelay,SingleDelay,Reverb});